{
  "name": "Notion Vocab AI Automation",
  "nodes": [
    {
      "id": "1",
      "name": "Notion Trigger",
      "type": "n8n-nodes-base.notionTrigger",
      "typeVersion": 1,
      "position": [200, 300],
      "parameters": {
        "resource": "database",
        "databaseId": "={{$env.NOTION_DATABASE_ID}}",
        "event": "pageUpdated",
        "filters": {
          "matchType": "anyFilter",
          "conditions": [
            {
              "property": "AI_done",
              "checkbox": {
                "equals": false
              }
            }
          ]
        },
        "options": {
          "limit": 20,
          "pollTime": "5m"
        }
      },
      "credentials": {
        "notionApi": {
          "id": "replace-with-your-credential-id",
          "name": "Notion Personal Integration"
        }
      }
    },
    {
      "id": "2",
      "name": "Prepare Payload",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [430, 300],
      "parameters": {
        "functionCode": "const promptTemplate = `You are an advanced English lexicographer who teaches vocabulary at a B2–C2 level. Output ONLY VALID JSON (no markdown, no code fences).\\n\\nAllowed POS values (choose only ONE):\\n- \"V: Intransitive\"\\n- \"V: Transitive\"\\n- \"V: Phrasal\"\\n- \"Noun\"\\n- \"Adjective\"\\n- \"Adverb\"\\n- \"Preposition\"\\n- \"Interjection\"\\n- \"Idiom\"\\n- \"Phrase\"\\n\\nYour JSON MUST include the keys: pos, ipa, synonyms, antonyms, example.\\n\\nRules:\\n- Use IPA slashes (e.g. \"/ˈtɛst/\").\\n- Synonyms: provide a short but meaningful set (max ~5), prioritizing useful B2–C2 vocabulary. Return as a JSON array of strings.\\n- Antonyms: include only when appropriate; also return as a JSON array of strings.\\n- Example: one natural, elegant sentence showing real usage.\\n- DO NOT include Thai, definitions, commentary, markdown, or backticks.\\n\\nReturn MINIFIED JSON like this:\\n{\\"pos\\":\\"Noun\\",\\"ipa\\":\\"/x/\\",\\"synonyms\\":[\\"a\\",\\"b\\"],\\"antonyms\\":[\\"c\\"],\\"example\\":\\"...\\"}\\n\\nWord: {{word}}`;\\n\\nreturn items\\n  .map(item => {\\n    const pageId = item.json.id;\\n    const word = item.json.English?.trim();\\n\\n    if (!word) return null;\\n\\n    const prompt = promptTemplate.replace('{{word}}', word);\\n\\n    return {\\n      json: {\\n        pageId,\\n        word,\\n        prompt,\\n      }\\n    };\\n  })\\n  .filter(Boolean);"
      }
    },
    {
      "id": "3",
      "name": "Call Ollama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [680, 300],
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ ($env.OLLAMA_BASE_URL || 'http://ollama:11434') + '/api/generate' }}",
        "jsonParameters": true,
        "options": {
          "bodyContentType": "json",
          "responseFormat": "json"
        },
        "body": "={{ { model: $env.OLLAMA_MODEL || 'phi3:mini', prompt: $json.prompt, format: 'json', stream: false } }}"
      }
    },
    {
      "id": "4",
      "name": "Transform AI JSON",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [920, 300],
      "parameters": {
        "functionCode": "// 1. Take raw NDJSON from Ollama\\nconst raw = $json.data || $json.body || $json.result || '';\\n\\n// 2. Split into NDJSON lines\\nconst lines = raw.split('\\n');\\n\\n// 3. Extract 'response' field from each line\\nlet pieces = [];\\nfor (const line of lines) {\\n  try {\\n    if (!line.trim()) continue;\\n    const obj = JSON.parse(line);\\n    if (typeof obj.response === 'string') {\\n      pieces.push(obj.response);\\n    }\\n  } catch (e) {}\\n}\\n\\n// 4. Merge all streamed tokens\\nlet merged = pieces.join('');\\n\\n// 5. Remove markdown fences\\nmerged = merged\\n  .replace(/```json/gi, '')\\n  .replace(/```/g, '')\\n  .trim();\\n\\n// 6. Find JSON object\\nconst match = merged.match(/\"{[\\s\\S]*}\"/);\\nif (!match) {\\n  throw new Error('No JSON object found:\\n' + merged);\\n}\\n\\nconst jsonString = match[0];\\n\\n// 7. Parse JSON\\nlet parsed;\\ntry {\\n  parsed = JSON.parse(jsonString);\\n} catch (err) {\\n  throw new Error('JSON parse failed:\\n' + err.message + '\\nRAW:\\n' + jsonString);\\n}\\n\\n// 8. Convert arrays to comma strings and flatten\\nfunction arrToString(arr) {\\n  if (!Array.isArray(arr)) return '';\\n  return arr.join(', ');\\n}\\n\\nconst synonyms = arrToString(parsed.synonyms);\\nconst antonyms = arrToString(parsed.antonyms);\\n\\n// 9. Build Notion properties (no Thai)\\nreturn [{\\n  json: {\\n    pageId: $items('Prepare Payload', 0, 0).json.pageId,\\n    properties: {\\n      Category: { select: { name: parsed.pos || 'unknown' } },\\n      Pronunciation: { rich_text: [{ text: { content: parsed.ipa || '' } }] },\\n      Synonyms: { rich_text: [{ text: { content: synonyms } }] },\\n      Antonyms: { rich_text: [{ text: { content: antonyms } }] },\\n      Example: { rich_text: [{ text: { content: parsed.example || '' } }] },\\n      AI_done: { checkbox: true }\\n    }\\n  }\\n}];"
      }
    },
    {
      "id": "5",
      "name": "Update Notion Page",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1170, 300],
      "parameters": {
        "resource": "page",
        "operation": "update",
        "pageId": "={{$json.pageId}}",
        "jsonParameters": true,
        "properties": "={{$json.properties}}"
      },
      "credentials": {
        "notionApi": {
          "id": "replace-with-your-credential-id",
          "name": "Notion Personal Integration"
        }
      }
    }
  ],
  "connections": {
    "Notion Trigger": {
      "main": [
        [
          {
            "node": "Prepare Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Payload": {
      "main": [
        [
          {
            "node": "Call Ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Ollama": {
      "main": [
        [
          {
            "node": "Transform AI JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform AI JSON": {
      "main": [
        [
          {
            "node": "Update Notion Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "saveManualExecutions": true
  },
  "versionId": "00000000-0000-0000-0000-000000000000"
}
